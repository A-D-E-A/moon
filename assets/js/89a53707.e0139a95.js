"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3157],{5318:(e,n,a)=>{a.d(n,{Zo:()=>p,kt:()=>m});var o=a(7378);function t(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function r(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,o)}return a}function l(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?r(Object(a),!0).forEach((function(n){t(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function s(e,n){if(null==e)return{};var a,o,t=function(e,n){if(null==e)return{};var a,o,t={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],n.indexOf(a)>=0||(t[a]=e[a]);return t}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(t[a]=e[a])}return t}var i=o.createContext({}),c=function(e){var n=o.useContext(i),a=n;return e&&(a="function"==typeof e?e(n):l(l({},n),e)),a},p=function(e){var n=c(e.components);return o.createElement(i.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},d=o.forwardRef((function(e,n){var a=e.components,t=e.mdxType,r=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(a),m=t,k=d["".concat(i,".").concat(m)]||d[m]||u[m]||r;return a?o.createElement(k,l(l({ref:n},p),{},{components:a})):o.createElement(k,l({ref:n},p))}));function m(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var r=a.length,l=new Array(r);l[0]=d;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s.mdxType="string"==typeof e?e:t,l[1]=s;for(var c=2;c<r;c++)l[c]=a[c];return o.createElement.apply(null,l)}return o.createElement.apply(null,a)}d.displayName="MDXCreateElement"},9798:(e,n,a)=>{a.d(n,{Z:()=>l});var o=a(7378),t=a(8944);const r="tabItem_wHwb";function l(e){let{children:n,hidden:a,className:l}=e;return o.createElement("div",{role:"tabpanel",className:(0,t.Z)(r,l),hidden:a},n)}},3337:(e,n,a)=>{a.d(n,{Z:()=>m});var o=a(5773),t=a(7378),r=a(8944),l=a(6457),s=a(784),i=a(9947),c=a(3457);const p="tabList_J5MA",u="tabItem_l0OV";function d(e){var n,a;const{lazy:l,block:d,defaultValue:m,values:k,groupId:f,className:g}=e,h=t.Children.map(e.children,(e=>{if((0,t.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),y=null!=k?k:h.map((e=>{let{props:{value:n,label:a,attributes:o}}=e;return{value:n,label:a,attributes:o}})),b=(0,s.l)(y,((e,n)=>e.value===n.value));if(b.length>0)throw new Error('Docusaurus error: Duplicate values "'+b.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.');const v=null===m?m:null!=(n=null!=m?m:null==(a=h.find((e=>e.props.default)))?void 0:a.props.value)?n:h[0].props.value;if(null!==v&&!y.some((e=>e.value===v)))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+v+'" but none of its children has the corresponding value. Available values are: '+y.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");const{tabGroupChoices:N,setTabGroupChoices:w}=(0,i.U)(),[C,O]=(0,t.useState)(v),x=[],{blockElementScrollPositionUntilNextRender:R}=(0,c.o5)();if(null!=f){const e=N[f];null!=e&&e!==C&&y.some((n=>n.value===e))&&O(e)}const j=e=>{const n=e.currentTarget,a=x.indexOf(n),o=y[a].value;o!==C&&(R(n),O(o),null!=f&&w(f,String(o)))},P=e=>{var n;let a=null;switch(e.key){case"ArrowRight":{var o;const n=x.indexOf(e.currentTarget)+1;a=null!=(o=x[n])?o:x[0];break}case"ArrowLeft":{var t;const n=x.indexOf(e.currentTarget)-1;a=null!=(t=x[n])?t:x[x.length-1];break}}null==(n=a)||n.focus()};return t.createElement("div",{className:(0,r.Z)("tabs-container",p)},t.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":d},g)},y.map((e=>{let{value:n,label:a,attributes:l}=e;return t.createElement("li",(0,o.Z)({role:"tab",tabIndex:C===n?0:-1,"aria-selected":C===n,key:n,ref:e=>x.push(e),onKeyDown:P,onFocus:j,onClick:j},l,{className:(0,r.Z)("tabs__item",u,null==l?void 0:l.className,{"tabs__item--active":C===n})}),null!=a?a:n)}))),l?(0,t.cloneElement)(h.filter((e=>e.props.value===C))[0],{className:"margin-top--md"}):t.createElement("div",{className:"margin-top--md"},h.map(((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==C})))))}function m(e){const n=(0,l.Z)();return t.createElement(d,(0,o.Z)({key:String(n)},e))}},9022:(e,n,a)=>{a.d(n,{Z:()=>r});var o=a(7378),t=a(9619);function r(e){let{header:n,updated:a,version:r}=e;return o.createElement(t.Z,{text:"v"+r,variant:a?"success":"info",className:n?"absolute right-0 top-1.5":"ml-2"})}},9619:(e,n,a)=>{a.d(n,{Z:()=>s});var o=a(7378),t=a(8944),r=a(8896);const l={failure:"bg-red-100 text-red-900",info:"bg-pink-100 text-pink-900",success:"bg-green-100 text-green-900",warning:"bg-orange-100 text-orange-900"};function s(e){let{className:n,icon:a,text:s,variant:i}=e;return o.createElement("span",{className:(0,t.Z)("inline-flex items-center px-1 py-0.5 rounded text-xs font-bold uppercase",i?l[i]:"bg-gray-100 text-gray-800",n)},a&&o.createElement(r.Z,{icon:a,className:"mr-1"}),s)}},5946:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>k,frontMatter:()=>i,metadata:()=>p,toc:()=>d});var o=a(5773),t=(a(7378),a(5318)),r=a(3337),l=a(9798),s=a(9022);const i={title:"Docker usage"},c=void 0,p={unversionedId:"guides/docker",id:"guides/docker",title:"Docker usage",description:"Using Docker to run your applications? Or build your artifacts? No",source:"@site/docs/guides/docker.mdx",sourceDirName:"guides",slug:"/guides/docker",permalink:"/docs/guides/docker",draft:!1,editUrl:"https://github.com/moonrepo/moon/tree/master/website/docs/guides/docker.mdx",tags:[],version:"current",frontMatter:{title:"Docker usage"},sidebar:"guides",previous:{title:"Code generation",permalink:"/docs/guides/codegen"},next:{title:"Open source usage",permalink:"/docs/guides/open-source"}},u={},d=[{value:"Performance improvements",id:"performance-improvements",level:2},{value:"Dockerfile",id:"dockerfile",level:2},{value:"What we&#39;re trying to avoid",id:"what-were-trying-to-avoid",level:3},{value:"Scaffolding the bare minimum",id:"scaffolding-the-bare-minimum",level:3},{value:"Copying necessary source files",id:"copying-necessary-source-files",level:3},{value:"Pruning extraneous files",id:"pruning-extraneous-files",level:3},{value:"Final result",id:"final-result",level:3}],m={toc:d};function k(e){let{components:n,...a}=e;return(0,t.kt)("wrapper",(0,o.Z)({},m,a,{components:n,mdxType:"MDXLayout"}),(0,t.kt)(s.Z,{header:!0,version:"0.15",mdxType:"VersionLabel"}),(0,t.kt)("p",null,"Using ",(0,t.kt)("a",{parentName:"p",href:"https://www.docker.com/"},"Docker")," to run your applications? Or build your artifacts? No\nworries, moon can be utilized with Docker, and supports a robust integration layer."),(0,t.kt)("admonition",{type:"success"},(0,t.kt)("p",{parentName:"admonition"},"Looking to speed up your Docker builds? Want to build in the cloud?\n",(0,t.kt)("a",{parentName:"p",href:"https://depot.dev?ref=moonrepo"},"Give Depot a try"),"!")),(0,t.kt)("h2",{id:"performance-improvements"},"Performance improvements"),(0,t.kt)("p",null,"For the most part, everything should just work, but we have disabled caching and hashing in Docker\ncontainers and images for the following reasons:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Avoids having to mount a volume for the ",(0,t.kt)("inlineCode",{parentName:"li"},".git")," directory."),(0,t.kt)("li",{parentName:"ul"},"Reduces the overall image size as we're avoiding creating tarballs."),(0,t.kt)("li",{parentName:"ul"},"Ensures that builds are fresh and up-to-date.")),(0,t.kt)("h2",{id:"dockerfile"},"Dockerfile"),(0,t.kt)("p",null,"We're very familiar with how tedious ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile"),"s are to write and maintain, so in an effort to\nreduce this headache, we've built a handful of tools to make this process much easier. With moon,\nwe'll take advantage of Docker's layer caching and staged builds as much as possible."),(0,t.kt)("p",null,"With that being said, there's many approaches you can utilize, depending on your workflow (we'll\ndocument them below):"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Running ",(0,t.kt)("inlineCode",{parentName:"li"},"moon docker")," commands ",(0,t.kt)("em",{parentName:"li"},"before")," running ",(0,t.kt)("inlineCode",{parentName:"li"},"docker run|build")," commands."),(0,t.kt)("li",{parentName:"ul"},"Running ",(0,t.kt)("inlineCode",{parentName:"li"},"moon docker")," commands ",(0,t.kt)("em",{parentName:"li"},"within")," the ",(0,t.kt)("inlineCode",{parentName:"li"},"Dockerfile"),"."),(0,t.kt)("li",{parentName:"ul"},"Using multi-staged or standard builds."),(0,t.kt)("li",{parentName:"ul"},"Something else unique to your setup!")),(0,t.kt)("h3",{id:"what-were-trying-to-avoid"},"What we're trying to avoid"),(0,t.kt)("p",null,"Before we dive into writing a perfect ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile"),", we'll briefly talk about the pain points we're\ntrying to avoid. In the context of Node.js and monorepo's, you may be familiar with having to ",(0,t.kt)("inlineCode",{parentName:"p"},"COPY"),"\neach individual ",(0,t.kt)("inlineCode",{parentName:"p"},"package.json")," in the monorepo before installing ",(0,t.kt)("inlineCode",{parentName:"p"},"node_modules"),", to effectively use\nlayer caching. This is very brittle, as each new application or package is created, every\n",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile")," in the monorepo will need to be modified to account for this new ",(0,t.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,t.kt)("p",null,"Furthermore, we'll have to follow a similar process for ",(0,t.kt)("em",{parentName:"p"},"only copying source files")," necessary for\nthe build or ",(0,t.kt)("inlineCode",{parentName:"p"},"CMD")," to complete. This is ",(0,t.kt)("em",{parentName:"p"},"very tedious"),", so most developers simply use ",(0,t.kt)("inlineCode",{parentName:"p"},"COPY . .")," and\nforget about it. Copying the entire monorepo is costly, especially as it grows."),(0,t.kt)("p",null,"As an example, we'll use moon's official repository. The ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile")," would look something like the\nfollowing."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"FROM node:latest\n\nWORKDIR /app\n\n# Install moon binary\nRUN npm install -g @moonrepo/cli\n\n# Copy moon files\nCOPY ./.moon ./.moon\n\n# Copy all package.json's and lockfiles\nCOPY ./packages/cli/package.json ./packages/cli/package.json\nCOPY ./packages/core-linux-arm64-gnu/package.json ./packages/core-linux-arm64-gnu/package.json\nCOPY ./packages/core-linux-arm64-musl/package.json ./packages/core-linux-arm64-musl/package.json\nCOPY ./packages/core-linux-x64-gnu/package.json ./packages/core-linux-x64-gnu/package.json\nCOPY ./packages/core-linux-x64-musl/package.json ./packages/core-linux-x64-musl/package.json\nCOPY ./packages/core-macos-arm64/package.json ./packages/core-macos-arm64/package.json\nCOPY ./packages/core-macos-x64/package.json ./packages/core-macos-x64/package.json\nCOPY ./packages/core-windows-x64-msvc/package.json ./packages/core-windows-x64-msvc/package.json\nCOPY ./packages/runtime/package.json ./packages/runtime/package.json\nCOPY ./packages/types/package.json ./packages/types/package.json\nCOPY ./package.json ./package.json\nCOPY ./yarn.lock ./yarn.lock\nCOPY ./.yarn ./.yarn\nCOPY ./.yarnrc.yml ./yarnrc.yml\n\n# Install toolchain and dependencies\nRUN moon setup\n\n# Copy project and required files\nCOPY ./packages/types ./packages/types\nCOPY ./packages/runtime ./packages/runtime\n# OR COPY . .\n\n# Build the target\nRUN moon run runtime:build\n")),(0,t.kt)("p",null,"For such a small monorepo, this already looks too confusing!!! Let's remedy this by utilizing moon\nitself to the fullest!"),(0,t.kt)("h3",{id:"scaffolding-the-bare-minimum"},"Scaffolding the bare minimum"),(0,t.kt)("p",null,"The first step in this process is to only copy the bare minimum of files necessary for installing\ndependencies (Node.js modules, etc). This is typically manifests (",(0,t.kt)("inlineCode",{parentName:"p"},"package.json"),"), lockfiles\n(",(0,t.kt)("inlineCode",{parentName:"p"},"yarn.lock"),", etc), and any configuration (",(0,t.kt)("inlineCode",{parentName:"p"},".yarnrc.yml"),", etc)."),(0,t.kt)("p",null,"This can all be achieved by the ",(0,t.kt)("a",{parentName:"p",href:"../commands/docker/scaffold"},(0,t.kt)("inlineCode",{parentName:"a"},"moon docker scaffold"))," command, which scaffolds a\nskeleton of the repository structure, with only necessary files (the above). Let's update our\n",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile")," usage."),(0,t.kt)(r.Z,{groupId:"dockerfile",defaultValue:"standard",values:[{label:"Standard",value:"standard"},{label:"Multi-staged",value:"staged"}],mdxType:"Tabs"},(0,t.kt)(l.Z,{value:"standard",mdxType:"TabItem"},(0,t.kt)("p",null,"This assumes ",(0,t.kt)("a",{parentName:"p",href:"../commands/docker/scaffold"},(0,t.kt)("inlineCode",{parentName:"a"},"moon docker scaffold <project>"))," is ran outside of the ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile"),"."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"FROM node:latest\nWORKDIR /app\n\n# Install moon binary\nRUN npm install -g @moonrepo/cli\n\n# Copy workspace skeleton\nCOPY ./.moon/docker/workspace .\n\n# Install toolchain and dependencies\nRUN moon setup\n"))),(0,t.kt)(l.Z,{value:"staged",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"#### BASE\nFROM node:latest AS base\nWORKDIR /app\n\n# Install moon binary\nRUN npm install -g @moonrepo/cli\n\n#### WORKSPACE\nFROM base AS workspace\nWORKDIR /app\n\n# Copy entire repository and scaffold\nCOPY . .\nRUN moon docker scaffold <project>\n\n#### BUILD\nFROM base AS build\nWORKDIR /app\n\n# Copy workspace skeleton\nCOPY --from=workspace /app/.moon/docker/workspace .\n\n# Install toolchain and dependencies\nRUN moon setup\n")))),(0,t.kt)("p",null,"And with this, our dependencies will be layer cached effectively! Let's now move onto copying source\nfiles."),(0,t.kt)("h3",{id:"copying-necessary-source-files"},"Copying necessary source files"),(0,t.kt)("p",null,"The next step is to copy all source files necessary for ",(0,t.kt)("inlineCode",{parentName:"p"},"CMD")," or any ",(0,t.kt)("inlineCode",{parentName:"p"},"RUN")," commands to execute\ncorrectly. This typically requires copying all source files for the project ",(0,t.kt)("em",{parentName:"p"},"and")," all source files\nof the project's dependencies... NOT the entire repository!"),(0,t.kt)("p",null,"Luckily our ",(0,t.kt)("a",{parentName:"p",href:"../commands/docker/scaffold"},(0,t.kt)("inlineCode",{parentName:"a"},"moon docker scaffold <project>"))," command has already done this for us! Let's\ncontinue updating our ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile")," to account for this, by appending the following:"),(0,t.kt)(r.Z,{groupId:"dockerfile",defaultValue:"standard",values:[{label:"Standard",value:"standard"},{label:"Multi-staged",value:"staged"}],mdxType:"Tabs"},(0,t.kt)(l.Z,{value:"standard",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"# Copy source files\nCOPY ./.moon/docker/sources .\n\n# Run something\nRUN moon run <project>:<task>\n"))),(0,t.kt)(l.Z,{value:"staged",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"# Copy source files\nCOPY --from=workspace /app/.moon/docker/sources .\n\n# Run something\nRUN moon run <project>:<task>\n")))),(0,t.kt)("admonition",{type:"info"},(0,t.kt)("p",{parentName:"admonition"},"If you need additional files for your commands to run successfully, you can manually use ",(0,t.kt)("inlineCode",{parentName:"p"},"COPY")," or\npass ",(0,t.kt)("inlineCode",{parentName:"p"},"--include")," to the scaffold command.")),(0,t.kt)("h3",{id:"pruning-extraneous-files"},"Pruning extraneous files"),(0,t.kt)("p",null,"Now that we've ran a command or built an artifact, we should prune the Docker environment to remove\nunneeded files and folders. We can do this with the ",(0,t.kt)("a",{parentName:"p",href:"../commands/docker/prune"},(0,t.kt)("inlineCode",{parentName:"a"},"moon docker prune"))," command, which\n",(0,t.kt)("em",{parentName:"p"},"must be ran")," within the context of a ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile"),"!"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"# Prune workspace\nRUN moon docker prune\n")),(0,t.kt)("p",null,"When ran, this command will do the following:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Install production only dependencies for the projects that were scaffolded."),(0,t.kt)("li",{parentName:"ul"},"Remove extraneous dependencies (",(0,t.kt)("inlineCode",{parentName:"li"},"node_modules"),") for unfocused projects.")),(0,t.kt)("h3",{id:"final-result"},"Final result"),(0,t.kt)("p",null,"And with this moon integration, we've reduced the original ",(0,t.kt)("inlineCode",{parentName:"p"},"Dockerfile")," of 35 lines to 18 lines, a\nreduction of almost 50%. The original file can also be seen as ",(0,t.kt)("inlineCode",{parentName:"p"},"O(n)"),", as each new manifest requires\ncascading updates, while the moon approach is ",(0,t.kt)("inlineCode",{parentName:"p"},"O(1)"),"!"),(0,t.kt)(r.Z,{groupId:"dockerfile",defaultValue:"standard",values:[{label:"Standard",value:"standard"},{label:"Multi-staged",value:"staged"}],mdxType:"Tabs"},(0,t.kt)(l.Z,{value:"standard",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"FROM node:latest\nWORKDIR /app\n\n# Install moon binary\nRUN npm install -g @moonrepo/cli\n\n# Copy workspace skeleton\nCOPY ./.moon/docker/workspace .\n\n# Install toolchain and dependencies\nRUN moon setup\n\n# Copy source files\nCOPY ./.moon/docker/sources .\n\n# Run something\nRUN moon run <project>:<task>\n\n# Prune workspace\nRUN moon docker prune\n\n# Or CMD\n"))),(0,t.kt)(l.Z,{value:"staged",mdxType:"TabItem"},(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-docker"},"#### BASE\nFROM node:latest AS base\nWORKDIR /app\n\n# Install moon binary\nRUN npm install -g @moonrepo/cli\n\n#### WORKSPACE\nFROM base AS workspace\nWORKDIR /app\n\n# Copy entire repository and scaffold\nCOPY . .\nRUN moon docker scaffold <project>\n\n#### BUILD\nFROM base AS build\nWORKDIR /app\n\n# Copy workspace skeleton\nCOPY --from=workspace /app/.moon/docker/workspace .\n\n# Install toolchain and dependencies\nRUN moon setup\n\n# Copy source files\nCOPY --from=workspace /app/.moon/docker/sources .\n\n# Run something\nRUN moon run <project>:<task>\n\n# Prune workspace\nRUN moon docker prune\n\n# Or CMD\n")))))}k.isMDXComponent=!0}}]);