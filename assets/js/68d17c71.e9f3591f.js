"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[25425],{35318:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>u});var a=t(27378);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=s(t),u=o,m=h["".concat(p,".").concat(u)]||h[u]||d[u]||r;return t?a.createElement(m,i(i({ref:n},c),{},{components:t})):a.createElement(m,i({ref:n},c))}));function u(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,i=new Array(r);i[0]=h;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<r;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},67107:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=t(25773),o=(t(27378),t(35318));const r={slug:"moon-v1.15",title:"moon v1.15 - Next-generation action graph",authors:["milesj"],tags:["action","dependency","graph","pipeline","railway"],image:"./img/moon/v1.15.png"},i=void 0,l={permalink:"/blog/moon-v1.15",editUrl:"https://github.com/moonrepo/moon/tree/master/website/blog/2023-10-09_moon-v1.15.mdx",source:"@site/blog/2023-10-09_moon-v1.15.mdx",title:"moon v1.15 - Next-generation action graph",description:"In this release, we've taken the next step in modernizing our action pipeline, by rewriting the",date:"2023-10-09T00:00:00.000Z",formattedDate:"October 9, 2023",tags:[{label:"action",permalink:"/blog/tags/action"},{label:"dependency",permalink:"/blog/tags/dependency"},{label:"graph",permalink:"/blog/tags/graph"},{label:"pipeline",permalink:"/blog/tags/pipeline"},{label:"railway",permalink:"/blog/tags/railway"}],readingTime:4.62,hasTruncateMarker:!0,authors:[{name:"Miles Johnson",title:"Founder, developer",url:"https://github.com/milesj",imageURL:"/img/authors/miles.jpg",key:"milesj"}],frontMatter:{slug:"moon-v1.15",title:"moon v1.15 - Next-generation action graph",authors:["milesj"],tags:["action","dependency","graph","pipeline","railway"],image:"./img/moon/v1.15.png"},prevItem:{title:"proto v0.20 - New shims and binaries management",permalink:"/blog/proto-v0.20"},nextItem:{title:"proto v0.19 - Version pinning and outdated checks",permalink:"/blog/proto-v0.19"}},p={image:t(2985).Z,authorsImageUrls:[void 0]},s=[{value:"Hello action graph, goodbye dependency graph",id:"hello-action-graph-goodbye-dependency-graph",level:2},{value:"A new performant thread pool",id:"a-new-performant-thread-pool",level:3},{value:"Automatic dependency linking (breaking)",id:"automatic-dependency-linking-breaking",level:3},{value:"New <code>moonrepo/setup-toolchain</code> GitHub action",id:"new-moonreposetup-toolchain-github-action",level:2},{value:"Now supported in Railway",id:"now-supported-in-railway",level:2},{value:"Other changes",id:"other-changes",level:2}],c={toc:s};function d(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this release, we've taken the next step in modernizing our action pipeline, by rewriting the\ndependency graph."),(0,o.kt)("h2",{id:"hello-action-graph-goodbye-dependency-graph"},"Hello action graph, goodbye dependency graph"),(0,o.kt)("p",null,"For the past few months, we've been working on a rewrite of our action pipeline, which consists of\nthe project graph, dependency graph, task executor, process pipeline, and more. It's a slow process,\nwith many different pieces that must land in sequence, but we're almost done. The next step in this\nprocess is the ",(0,o.kt)("a",{parentName:"p",href:"/docs/how-it-works/action-graph"},"introduction of the new action graph"),", which\nreplaces the previous dependency graph."),(0,o.kt)("p",null,"For the most part, the graphs work in a similar fashion, but since we rewrote it from the ground up,\nwe were able to resolve any discrepancies and performance issues. The biggest changes between the\nnew and old graphs are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"All actions now depend on the ",(0,o.kt)("inlineCode",{parentName:"li"},"SyncWorkspace")," action, instead of this action running arbitrarily."),(0,o.kt)("li",{parentName:"ul"},"Cleaned up dependency chains between actions, greatly reducing the number of nodes in the graph."),(0,o.kt)("li",{parentName:"ul"},"Renamed ",(0,o.kt)("inlineCode",{parentName:"li"},"RunTarget")," to ",(0,o.kt)("inlineCode",{parentName:"li"},"RunTask"),", including interactive and persistent variants."),(0,o.kt)("li",{parentName:"ul"},"And lastly, we ditched our batched task approach for a ready queue. Continue reading for more\ninformation!")),(0,o.kt)("h3",{id:"a-new-performant-thread-pool"},"A new performant thread pool"),(0,o.kt)("p",null,"In the old dependency graph, when we'd execute a task, we'd order the graph topologically and then\ngroup actions into batches (or buckets) based on their dependency chains. Batches would then be\nexecuted in order within the thread pool. This approach worked well, but had one major flaw: it\nwasn't as performant as could be. For example, if our thread pool size was 12, and a batch only had\n2 tasks in it, what were the other 10 threads doing? Absolutely nothing. They were sitting idly,\nwaiting for a task."),(0,o.kt)("p",null,"And now with the new action graph, we take full advantage of all threads in the pool. Instead of the\nbatched approach above, we now use a topological task-ready queue, where a thread without work (or\nis waiting for work) can poll the graph for a new task to run. A task is considered ready to run if\nit either has no dependencies, or all of its dependencies (in the chain) have been ran."),(0,o.kt)("p",null,"For large graphs, this should result in a significant performance improvement!"),(0,o.kt)("h3",{id:"automatic-dependency-linking-breaking"},"Automatic dependency linking (breaking)"),(0,o.kt)("p",null,'Because of these graph changes, we do have a minor "breaking change". Tasks that depend (via ',(0,o.kt)("inlineCode",{parentName:"p"},"deps"),')\non other tasks from arbitrary projects (the parent project doesn\'t implicitly or explicitly depend\non the other project), not including the root-level project, will now automatically mark that other\nproject as a "peer" dependency (if not already configured with ',(0,o.kt)("inlineCode",{parentName:"p"},"dependsOn"),'). For example, "b"\nbecomes a peer dependency for "a".'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="a/moon.yml"',title:'"a/moon.yml"'},"tasks:\n  build:\n    deps: ['b:build']\n")),(0,o.kt)("p",null,"Now internally becomes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="a/moon.yml"',title:'"a/moon.yml"'},"dependsOn:\n  - id: 'b'\n    scope: 'peer'\n\ntasks:\n  build:\n    deps: ['b:build']\n")),(0,o.kt)("p",null,"If you'd prefer this dependency to ",(0,o.kt)("em",{parentName:"p"},"not be"),' a peer, you can explicitly configure it with a different\nscope. For Node.js projects, the "build" scope can be used as a no-op replacement.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="a/moon.yml"',title:'"a/moon.yml"'},"dependsOn:\n  - id: 'b'\n    scope: 'build' # production, development\n\ntasks:\n  build:\n    deps: ['b:build']\n")),(0,o.kt)("p",null,"We're marking this as a breaking change as this could subtly introduce cycles in the project graph\nthat weren't present before, and for Node.js projects, this may inject ",(0,o.kt)("inlineCode",{parentName:"p"},"peerDependencies"),". However,\nthis change was necessary to ensure accurate dependency chains in the graph."),(0,o.kt)("h2",{id:"new-moonreposetup-toolchain-github-action"},"New ",(0,o.kt)("inlineCode",{parentName:"h2"},"moonrepo/setup-toolchain")," GitHub action"),(0,o.kt)("p",null,"We've begun a process to deprecate the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/moonrepo/setup-moon-action"},"moonrepo/setup-moon-action")," and\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/moonrepo/setup-proto"},"moonrepo/setup-proto")," GitHub actions, and instead, combine\nand replace them with a new ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/moonrepo/setup-toolchain"},"moonrepo/setup-toolchain"),"\naction. Why a new action instead of fixing the others?"),(0,o.kt)("p",null,"The biggest problem was that both previous actions shared about 90% of the same code, but were\nslightly different in how they installed the binaries and cached the toolchain. It was was also\nconfusing for consumers to understand and know which action to use (because they shouldn't be used\ntogether)."),(0,o.kt)("p",null,"To remedy this, we're prototyping the new\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/moonrepo/setup-toolchain"},"moonrepo/setup-toolchain")," action, which has been\nworking quite well. It aims to solve the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Installs ",(0,o.kt)("inlineCode",{parentName:"li"},"proto")," globally so that installed tools can also be executed globally."),(0,o.kt)("li",{parentName:"ul"},"Conditionally installs ",(0,o.kt)("inlineCode",{parentName:"li"},"moon")," globally if the repository is using moon (attempts to detect a\n",(0,o.kt)("inlineCode",{parentName:"li"},".moon")," directory)."),(0,o.kt)("li",{parentName:"ul"},"Caches the toolchain (",(0,o.kt)("inlineCode",{parentName:"li"},"~/.proto"),") so subsequent runs are faster."),(0,o.kt)("li",{parentName:"ul"},"Hashes ",(0,o.kt)("inlineCode",{parentName:"li"},".prototools")," and ",(0,o.kt)("inlineCode",{parentName:"li"},".moon/toolchain.yml")," files to generate a unique cache key."),(0,o.kt)("li",{parentName:"ul"},"Cleans the toolchain before caching to remove unused or stale tools."),(0,o.kt)("li",{parentName:"ul"},"Can auto-install tools when used.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-diff"},"# ...\njobs:\n  ci:\n    name: CI\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n-      - uses: moonrepo/setup-moon-action@v1\n+      - uses: moonrepo/setup-toolchain@v0\n")),(0,o.kt)("h2",{id:"now-supported-in-railway"},"Now supported in Railway"),(0,o.kt)("p",null,"If you're a big fan of ",(0,o.kt)("a",{parentName:"p",href:"https://railway.app/"},"Railway")," (like we are), and you're deploying a Node.js\nbacked application, then you'll be happy to hear that Railway now officially and natively supports\nmoon! We spent some time over the past month\n",(0,o.kt)("a",{parentName:"p",href:"https://nixpacks.com/docs/providers/node"},"integrating moon support into their Nixpacks architecture"),"."),(0,o.kt)("p",null,"To make use of this, set the ",(0,o.kt)("inlineCode",{parentName:"p"},"NIXPACKS_MOON_APP_NAME")," environment variable to the name of your moon\nproject that you want to be deployed. This will then automatically run ",(0,o.kt)("inlineCode",{parentName:"p"},"moon run <app>:build")," and\n",(0,o.kt)("inlineCode",{parentName:"p"},"moon run <app>:start")," respectively. To customize the task names, you can set the\n",(0,o.kt)("inlineCode",{parentName:"p"},"NIXPACKS_MOON_BUILD_TASK")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"NIXPACKS_MOON_START_TASK")," environment variables."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"This is currently only supported for Node.js projects, but will be expanded to other languages in\nthe future!")),(0,o.kt)("h2",{id:"other-changes"},"Other changes"),(0,o.kt)("p",null,"View the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/moonrepo/moon/releases/tag/v1.15.0"},"official release")," for a full list\nof changes."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Added a ",(0,o.kt)("inlineCode",{parentName:"li"},"moon action-graph")," command."),(0,o.kt)("li",{parentName:"ul"},"Added a ",(0,o.kt)("inlineCode",{parentName:"li"},"--dependents")," argument to ",(0,o.kt)("inlineCode",{parentName:"li"},"moon action-graph"),"."),(0,o.kt)("li",{parentName:"ul"},"Added the ability to skip non-",(0,o.kt)("inlineCode",{parentName:"li"},"RunTask")," actions using environment variables."),(0,o.kt)("li",{parentName:"ul"},"Deprecated the ",(0,o.kt)("inlineCode",{parentName:"li"},"moon dep-graph")," command.")))}d.isMDXComponent=!0},2985:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/v1.15-24f6509aa7bcbfaf9ac48f4d63883483.png"}}]);